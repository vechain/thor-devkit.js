import { expect } from "chai"
import { OldAbi } from "../../src"
import { ethers } from "ethers"

describe('abi regression check', () => {

    // Low level coders
    const coder = new OldAbi.Coder()
    const ethersCoder = new ethers.AbiCoder()

    // Demonstrate compatibility between old and new ethers abi coder
    it('LOW LEVEL encode', () => {
        // Old
        expect(coder.encode(['uint256'], ['2345675643'])).equal('0x000000000000000000000000000000000000000000000000000000008bd02b7b')
        expect(() => coder.encode(['bytes32'], ['0xdf3234'])).to.throw()

        expect(coder.encode(['bytes32'], ['0xdf32340000000000000000000000000000000000000000000000000000000000'])).equal('0xdf32340000000000000000000000000000000000000000000000000000000000')
        expect(coder.encode(['bytes'], ['0xdf3234'])).equal('0x00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000003df32340000000000000000000000000000000000000000000000000000000000')
        expect(coder.encode(['uint256'], ['2345675643'])).equal('0x000000000000000000000000000000000000000000000000000000008bd02b7b')
        expect(coder.encode(['bytes32[]'], [['0xdf32340000000000000000000000000000000000000000000000000000000000', '0xfdfd000000000000000000000000000000000000000000000000000000000000']])).equal('0x00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000002df32340000000000000000000000000000000000000000000000000000000000fdfd000000000000000000000000000000000000000000000000000000000000')

        // New
        expect(ethersCoder.encode(['uint256'], ['2345675643'])).equal('0x000000000000000000000000000000000000000000000000000000008bd02b7b')
        expect(() => ethersCoder.encode(['bytes32'], ['0xdf3234'])).to.throw()

        expect(ethersCoder.encode(['bytes32'], ['0xdf32340000000000000000000000000000000000000000000000000000000000'])).equal('0xdf32340000000000000000000000000000000000000000000000000000000000')
        expect(ethersCoder.encode(['bytes'], ['0xdf3234'])).equal('0x00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000003df32340000000000000000000000000000000000000000000000000000000000')
        expect(ethersCoder.encode(['uint256'], ['2345675643'])).equal('0x000000000000000000000000000000000000000000000000000000008bd02b7b')
        expect(ethersCoder.encode(['bytes32[]'], [['0xdf32340000000000000000000000000000000000000000000000000000000000', '0xfdfd000000000000000000000000000000000000000000000000000000000000']])).equal('0x00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000002df32340000000000000000000000000000000000000000000000000000000000fdfd000000000000000000000000000000000000000000000000000000000000')

        // Compare
        expect(ethersCoder.encode(['uint256'], ['2345675643']))
            .equal(coder.encode(['uint256'], ['2345675643']))

        expect(ethersCoder.encode(['bytes32'], ['0xdf32340000000000000000000000000000000000000000000000000000000000']))
            .equal(coder.encode(['bytes32'], ['0xdf32340000000000000000000000000000000000000000000000000000000000']))

        expect(ethersCoder.encode(['bytes'], ['0xdf3234']))
            .equal(coder.encode(['bytes'], ['0xdf3234']))

        expect(ethersCoder.encode(['uint256'], ['2345675643']))
            .equal(coder.encode(['uint256'], ['2345675643']))

        expect(ethersCoder.encode(['bytes32[]'], [['0xdf32340000000000000000000000000000000000000000000000000000000000', '0xfdfd000000000000000000000000000000000000000000000000000000000000']]))
            .equal(coder.encode(['bytes32[]'], [['0xdf32340000000000000000000000000000000000000000000000000000000000', '0xfdfd000000000000000000000000000000000000000000000000000000000000']]))
    })

    // Demonstrate compatibility between old and new ethers abi coder
    it('LOW LEVEL decode', () => {
        // Old
        expect(coder.decode(['uint256'], '0x0000000000000000000000000000000000000000000000000000000000000010')[0]).equal("16")
        expect(coder.decode(['string'], '0x0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000848656c6c6f212521000000000000000000000000000000000000000000000000')[0])
            .equal("Hello!%!")
        expect(coder.decode(['string'], '0x0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000848656c6c6f212521000000000000000000000000000000000000000000000000')[0])
            .equal("Hello!%!")

        expect(() => coder.decode(['uint256'], 'WRONG_UINT')[0]).to.throw()

        // New
        expect(ethersCoder.decode(['uint256'], '0x0000000000000000000000000000000000000000000000000000000000000010').values().next().value.toString()).equal("16")
        expect(ethersCoder.decode(['string'], '0x0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000848656c6c6f212521000000000000000000000000000000000000000000000000').values().next().value.toString())
            .equal("Hello!%!")
        expect(ethersCoder.decode(['string'], '0x0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000848656c6c6f212521000000000000000000000000000000000000000000000000').values().next().value.toString())
            .equal("Hello!%!")

        expect(() => ethersCoder.decode(['uint256'], 'WRONG_UINT').values().next().value.toString()).to.throw()
    })
})